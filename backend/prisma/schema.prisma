generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum GlobalRole {
  ADMIN
  STUDENT
}

enum ClubRole {
  MEMBER
  ORGANIZER
  HEAD
}

enum EventStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PUBLISHED
  COMPLETED
}

enum ResourceType {
  ROOM
  HALL
  LAB
  EQUIPMENT
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  name         String
  department   String?
  academicYear String?
  globalRole   GlobalRole     @default(STUDENT)
  memberships  Membership[]
  roleRequests RoleRequest[]
  events       Event[]       @relation("CreatedEvents")
  registrations Registration[]
  notifications Notification[]
  auditLogs    AuditLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Club {
  id           String        @id @default(uuid())
  name         String        @unique
  description  String?
  memberships  Membership[]
  roleRequests RoleRequest[]
  events       EventClub[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Membership {
  id        String   @id @default(uuid())
  userId    String
  clubId    String
  clubRole  ClubRole @default(MEMBER)
  user      User     @relation(fields: [userId], references: [id])
  club      Club     @relation(fields: [clubId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, clubId])
}

model RoleRequest {
  id           String    @id @default(uuid())
  userId       String
  clubId       String
  requestedRole ClubRole // ORGANIZER
  status       String   @default("PENDING") // PENDING | APPROVED | REJECTED
  reviewedById String?
  reviewedAt   DateTime?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])
  club         Club     @relation(fields: [clubId], references: [id])
  @@unique([userId, clubId])
}

model Event {
  id                   String       @id @default(uuid())
  title                String
  description          String?
  location             String?
  startDate            DateTime
  endDate              DateTime
  status               EventStatus  @default(DRAFT)
  submittedAt          DateTime?    // set when status becomes SUBMITTED (for SLA display)
  createdById          String
  createdBy            User         @relation("CreatedEvents", fields: [createdById], references: [id])
  budgetEstimate       Int?
  budgetFinal          Int?
  rejectionReason      String?
  participationFee     Int?
  teamSizeMin          Int?
  teamSizeMax          Int?
  category             String?
  eligibilityTags      String?
  registrationDeadline DateTime?
  clubs                EventClub[]
  bookings             Booking[]
  registrations        Registration[]
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
}

model EventClub {
  id      String @id @default(uuid())
  eventId String
  clubId  String
  event   Event  @relation(fields: [eventId], references: [id])
  club    Club   @relation(fields: [clubId], references: [id])
  @@unique([eventId, clubId])
}

model Resource {
  id              String       @id @default(uuid())
  name            String       @unique
  type            ResourceType
  requiresApproval Boolean     @default(true)
  autoApprove     Boolean      @default(false)
  capacity        Int?
  active          Boolean      @default(true)  // false = soft delete, not bookable
  bookings        Booking[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Booking {
  id          String   @id @default(uuid())
  resourceId  String
  eventId     String
  startTime   DateTime
  endTime     DateTime
  approved    Boolean  @default(false)
  rejected    Boolean  @default(false)
  rejectionReason String?
  resource    Resource @relation(fields: [resourceId], references: [id])
  event       Event    @relation(fields: [eventId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([resourceId, startTime, endTime])
}

model Registration {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  @@unique([eventId, userId])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  category  String?   // Events | Bookings | System
  message   String
  read      Boolean   @default(false)
  readAt    DateTime? // when marked read
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}
